# EgressPolicy E2E 用例

- 用例中，所有有关 `eip` 校验的内容，都包含了 tcp，udp 和 web socket

| 用例编号   | 标题                                                                                                                                                                                                                            | 优先级 | 冒烟    | 状态   | 其他 |
|--------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----|-------|------|----|
| P00001 | 当使用不合法的 `EgressIP`，创建 EgressPolicy 失败                                                                                                                                                                                         | p2  | false | done |    |
| P00002 | 当 `EgressGatewayName` 为空时，创建集群级 `EgressPolicy` 时，会使用集群默认的 `EgressGateway`，检查 `EgressPolicySpec.EgressGatewayName` 及 `EgressPolicyStatus` 状态正确                                                                                 | p2  | false | done |    |
| P00003 | 当 `EgressGatewayName` 为空时，创建租户级 `EgressPolicy`时，如果对应租户注解上有相关 `EgressGateway` 的标注，则使用标注的 `EgressGatewa`，如果没有则使用集群默认的 `EgressGateway`，检查 `EgressPolicySpec.EgressGatewayName` 及 `EgressPolicyStatus` 状态正确                       | p2  | false | done |    |
| P00004 | 当 `EgressIP` 没有在 `Policy` 所选择的 `egressGateway` 的 `Ippools` 范围内，创建 EgressPolicy 会失败                                                                                                                                            | p2  | false | done |    |
| P00005 | 当 `AppliedTo` 为空时，创建 EgressPolicy 会失败                                                                                                                                                                                         | p2  | false | done |    |
| P00006 | 当同时设置 `AppliedTo.PodSubnet` 和 `AppliedTo.PodSelector` 时，创建 `Policy` 失败                                                                                                                                                        | p2  | false | done |    |
| P00007 | 当只设置了 `AppliedTo.PodSubnet`，与之匹配到的 `Pod` 的出口 IP 应是 `eip`，没有匹配到的 `Pod` 的出口 IP，应为非 `eip`，并且 `endpointSlice` 不会被创建                                                                                                               | p1  | true  | done |    |
| P00008 | 当 `EgressIP` 为空并且设置了 `AppliedTo.PodSelector` 时，`Policy` 的 `EgressPolicyStatus.Eip` 和 Pod 的出口 IP 为 `egressGateway` 的 `defaultEIP`，`policy` 的 `allocatorPolicy` 为 `default`、`useNodeIP` 为 `false`， `EgressGatewayStatus` 会如预期更新 | p1  | true  | done |    |
| P00009 | 当 `EgressIP` 的 IP 为空，并且 `EgressIP.AllocatorPolicy` 为轮询模式时， `eip` 会从 `EgressGatewaySpec.Ippools` 的 IP 中获取，检查 `EgressPolicyStatus` 和 `EgressGatewayStatus` 状态正确                                                                 | p2  | false | done |    |
| P00010 | 当 `EgressIP` 的 IP 不为空，并且 `EgressIP.AllocatorPolicy` 为轮询模式时， `EgressIP` 会生效， 检查 `EgressPolicyStatus` 和 `EgressGatewayStatus` 状态正确                                                                                              | p2  | false | done |    |
| P00011 | 当 `Policy` 的 `DestSubnet` 为空并且访问的目的 IP 不在 `egressClusterInfo.Status` 中的 IP 列表范围之内时，<br/>Pod 的出口 IP 为 `eip`                                                                                                                    | p1  | true  | done |    |
| P00012 | 当 `Policy` 的 `DestSubnet` 为空并且访问的目的 IP 在 `egressClusterInfo.Status` 中的 IP 列表范围之内时，<br/>Pod 的出口 IP 不为 `eip`                                                                                                                    | p1  | true  | done |    |
| P00013 | 设置 `DestSubnet` 和 `PodSelector`, 当访问与 `DestSubnet` 匹配的外部 IP 时，Pod 的出口 IP 为 `eip`,<br/>当访问与 `DestSubnet` 不匹配的外部 IP 时， Pod 的出口 IP 为非 `eip`                                                                                      | p1  | true  | done |    |
| P00014 | 编辑原本匹配 `DaemonSet-A` 的 `PodSelector` ，使之改为匹配 `DaemonSet-B`,<br/> `EgressEndpoint` 会由 `DaemonSet-A` 更新为 `DaemonSet-B` 的信息，<br/>并且 `DaemonSet-A` 所有 Pod 的 出口 IP 由 `eip` 改为非 `eip`，`DaemonSet-B` 所有 Pod 的出口 IP 由非 `eip` 改为 `eip` | p1  | true  | done |    |
| P00015 | 当 `EgressIP.UseNodeIP` 为 `true` 并且 `EgressIP` 的 IP 为空时，创建 `EgressPolicy`，<br/>`EgressPolicyStatus.Eip` 和 `EgressGatewayStatus.Eips` 的 IP 应该为空，并且 Pod 的出口 IP 为 egressGateway `nodeSelector` 所匹配的 node 的 IP                     | p1  | true  | done |    |
| P00016 | 当 `EgressIP.UseNodeIP` 为 `true` 并且 `EgressIP` 的 IP 为空时，<br/>修改EgressGateway 的 `nodeSelector` 匹配另一个节点，并且 Pod 的出口 IP 为 egressGateway `nodeSelector` 新匹配的 node 的 IP                                                              | p1  | true  | done |    |
| P00017 | 当 `EgressIP.UseNodeIP` 为 `true` 并且 `EgressIP` 的 IP 不为空时，创建 `EgressPolicy` 会失败                                                                                                                                                 | p2  | false | done |    |
| P00018 | 当编辑 Policy 的 `EgressIP` 的 IP 时，会报错                                                                                                                                                                                            | p2  | false | done |    |
| P00019 | 当编辑 Policy 的 `EgressGatewayName` 时，会报错                                                                                                                                                                                        | p2  | false | done |    |
| P00020 | 当删除 Policy，`EgressGatewayStatus` 和 `EgressEndpoint` 将如预期更新，并且 Pod 的出口 IP 由 `eip` 改为非 `eip`                                                                                                                                    | p1  | true  | done |    |
| P00021 | `namespace-level` 的 Policy 只生效在它所指定的命名空间                                                                                                                                                                                      | p2  | false | done |    |
| P00022 | 当 `spec.EgressIP.IPv4` or `spec.EgressIP.IPv6` 不为空时, 创建的 Policy 需要使用指定的 IP 地址。                                                                                                                                                | p2  | false | done |    |
